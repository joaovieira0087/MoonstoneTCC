@{
    var historicoPorMes = ViewBag.HistoricoAgrupado as IEnumerable<IGrouping<dynamic, MoonstoneTCC.Models.HistoricoVisualizacao>>;
}

<div class="container mt-5 text-white">
    <h2 class="fw-bold mb-4">
        <i class="fas fa-history text-purple me-2"></i> Histórico de Jogos Visualizados
    </h2>

    <!-- Filtro de mês/ano -->
    <form method="get" class="mb-4">
        <div class="d-flex gap-2 flex-wrap">
            <select name="mes" class="form-select w-auto">
                <option value="">Todos os Meses</option>
                <option value="1">Janeiro</option>
                <option value="2">Fevereiro</option>
                <option value="3">Março</option>
                <option value="4">Abril</option>
                <option value="5">Maio</option>
                <option value="6">Junho</option>
                <option value="7">Julho</option>
                <option value="8">Agosto</option>
                <option value="9">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
            </select>
            <select name="ano" class="form-select w-auto">
                <option value="">Todos os Anos</option>
                <option value="2025">2025</option>
                <option value="2024">2024</option>
            </select>
            <button class="btn btn-purple"><i class="fas fa-filter me-1"></i> Filtrar</button>
        </div>
    </form>

    <form id="formLimparHistorico" asp-controller="Historico" asp-action="Limpar" method="post" class="mt-4">
        <button type="button" class="btn btn-outline-danger" onclick="abrirModalConfirmacao()">
            <i class="fas fa-trash-alt"></i> Limpar Todo o Histórico
        </button>
    </form>

    <div id="modalConfirmacao" class="modal-bg" style="display:none;">
        <div class="modal-box shadow-lg">
            <div class="modal-header-custom mb-3">
                <i class="fas fa-exclamation-triangle fa-lg text-warning me-2"></i>
                <span class="modal-title text-white fw-bold fs-5">Confirmar Limpeza de Histórico</span>
            </div>
            <p class="text-light mb-4">Tem certeza que deseja apagar todo o histórico de jogos visualizados?</p>
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-outline-secondary px-4" onclick="fecharModalConfirmacao()">
                    <i class="fas fa-times-circle me-1"></i> Cancelar
                </button>
                <button type="button" class="btn btn-purple px-4" onclick="document.getElementById('formLimparHistorico').submit();">
                    <i class="fas fa-check-circle me-1"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    @if (historicoPorMes == null || !historicoPorMes.Any())
    {
        <div class="alert alert-info carousel-container text-center mt-4">
            <i class="fas fa-info-circle me-2"></i>
            Você ainda não visualizou nenhum jogo.
        </div>
    }
    else
    {
        foreach (var grupo in historicoPorMes)
        {
            var mesNome = new System.Globalization.CultureInfo("pt-BR").DateTimeFormat.GetMonthName(grupo.Key.Month);
            <h3 class="text-light mt-4">
                @char.ToUpper(mesNome[0])@mesNome.Substring(1) de @grupo.Key.Year
            </h3>
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
                @foreach (var item in grupo)
                {
                    <div class="col">
                        <div class="carousel-container h-100 d-flex flex-column p-3 rounded-4 shadow-lg">
                            <!-- Imagem -->
                            <div class="text-center mb-3">
                                <img src="@item.Jogo.ImagemThumbnailUrl"
                                     alt="@item.Jogo.Nome"
                                     class="img-fluid rounded shadow"
                                     style="max-height: 200px; object-fit: cover;" />
                            </div>

                            <!-- Informações -->
                            <div class="text-white text-center flex-grow-1">
                                <h5 class="fw-bold">@item.Jogo.Nome</h5>
                                <p class="mb-1">
                                    <i class="fas fa-clock me-1"></i> Visualizado em: @item.DataVisualizacao.ToString("dd/MM/yyyy HH:mm")
                                </p>
                                <p class="fw-semibold text-success">R$ @item.Jogo.Preco.ToString("F2")</p>
                            </div>

                            <!-- Ações -->
                            <div class="mt-3 d-grid gap-2">
                                <a asp-controller="CarrinhoCompra" asp-action="ComprarAgora" asp-route-jogoId="@item.JogoId" class="btn btn-success d-flex justify-content-center align-items-center">
                                    <i class="fas fa-bolt me-2"></i> Comprar Agora
                                </a>

                                <a asp-controller="CarrinhoCompra" asp-action="AdicionarItemNoCarrinhoCompra" asp-route-jogoId="@item.JogoId"
                                   class="btn btn-outline-light d-flex justify-content-center align-items-center">
                                    <i class="fas fa-cart-plus me-2"></i> Adicionar ao Carrinho
                                </a>

                                <a asp-controller="Jogo" asp-action="Details" asp-route-jogoId="@item.JogoId"
                                   class="btn btn-primary d-flex justify-content-center align-items-center">
                                    <i class="fas fa-eye me-2"></i> Ver Detalhes
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

    <style>
        .btn-purple {
            background-color: #9d3ce6;
            color: white;
            border: none;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .btn-purple:hover {
            background-color: #b362f1;
        }
    </style >


<script>
    function abrirModalConfirmacao() {
        document.getElementById("modalConfirmacao").style.display = "flex";
    }

    function fecharModalConfirmacao() {
        document.getElementById("modalConfirmacao").style.display = "none";
    }
</script>
